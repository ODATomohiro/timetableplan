<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>1週間スケジュールメーカー（1ページ印刷対応）</title>
<style>
  :root{ --bg:#f7f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; color:var(--ink); background:var(--bg);}
  .wrap{max-width:1100px; margin:0 auto; padding:16px}
  h1{margin:8px 0 12px; font-size:clamp(18px,3vw,26px)}
  .card{background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px 14px; box-shadow:0 1px 6px rgba(0,0,0,.05)}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  label{font-size:12px; color:var(--muted)}
  input[type=text],input[type=time],select{border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:14px; background:#fff}
  input[type=color]{border:1px solid var(--line); border-radius:6px; height:36px; width:48px}
  button{border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
  button.primary{background:#3b82f6; color:#fff; border-color:transparent}
  .palette{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .tag{user-select:none; display:inline-flex; align-items:center; gap:6px; border:1px solid var(--line); padding:6px 10px; border-radius:999px; background:#fff; cursor:pointer}
  .tag.active{outline:2px solid #2563eb}
  .dot{width:12px; height:12px; border-radius:50%; outline:1px solid rgba(0,0,0,.06)}
  .gridwrap{overflow:auto}
  table{border-collapse:separate; border-spacing:0; min-width:900px;}
  th,td{border:1px solid var(--line)}
  th{position:sticky; top:0; background:#fafafa}
  thead th.timecol{left:0; z-index:2; position:sticky; background:#fafafa}
  tbody .timecol{position:sticky; left:0; background:#fcfcfc; font-weight:600; color:#374151}
  td,th{padding:6px 8px; font-size:12px; text-align:center}
  td.slot{min-width:100px; height:26px; background:#fff; cursor:crosshair; user-select:none}
  td.slot[data-item]{color:#fff; font-weight:700}
  .totals{display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:8px; margin-top:8px}
  .pill{background:#f3f4f6; border-radius:999px; padding:6px 10px; font-size:12px; display:flex; align-items:center; gap:6px}
  .small{font-size:12px; color:#6b7280}
  /* THP */
  .thp{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:10px}
  .thp .c{border:1px solid var(--line); border-radius:12px; padding:10px; background:#fff}
  .thp .ok{border-color:#d1fae5; background:#f0fdf4}
  .thp .warn{border-color:#fef3c7; background:#fffbeb}
  .thp h4{margin:0 0 4px; font-size:13px}
  .thp p{margin:0; font-size:12px; color:#374151}
  /* ---- 印刷（A4 1ページに収める） ---- */
  @media print{
    @page { size: A4 portrait; margin: 8mm; }
    html, body{ background:#fff !important; }
    .wrap{ max-width:100%; padding:0; }
    /* 画面の操作系は印刷しない */
    #controls, .palette label, .small:has(> b:contains('使い方')) { display:none !important; }
    /* 表示対象：タイトル＋スケジュール＋THP */
    #printHeader, #cardSchedule, #cardTHP { display:block !important; page-break-inside: avoid; }
    h1{ display:none; }
    #printHeader{ margin-bottom:6px; }
    #printHeader input{ display:none; }         /* 入力欄は隠す */
    #titleDisplay{ font-size:16px; margin:0 0 4px; }
    /* 密度を下げる（＝詰める） */
    table{ font-size:9px; }
    td.slot{ height:14px; }
    th, td{ padding:2px 4px; }
    .totals{ grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:4px; margin-top:6px; }
    .pill{ padding:3px 6px; font-size:9px; }
    .thp{ grid-template-columns:repeat(2, 1fr); gap:6px; }
    .thp .c{ padding:6px; }
    .thp h4{ font-size:11px; margin-bottom:2px; }
    .thp p, .small{ font-size:9px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>1週間スケジュールメーカー <span class="small">（5:00始まり／30分刻み／ドラッグ塗り／CSV・印刷）</span></h1>

    <!-- タイトル入力＋プレビュー -->
    <div id="printHeader" class="card" style="margin-bottom:12px">
      <div class="row" style="align-items:end">
        <div style="flex:1">
          <label>タイトル（印刷に入ります）</label>
          <input id="titleInput" type="text" placeholder="例：その職業について考えるワーク／1週間の生活計画" style="width:100%" />
        </div>
      </div>
      <h2 id="titleDisplay" style="margin:8px 0 0 2px">（タイトル）</h2>
      <div class="small">※ 入力欄は画面表示用、印刷時は上の太字タイトルだけが出力されます。</div>
    </div>

    <!-- 上：シンプル動作版 -->
    <div class="row" id="controls">
      <div class="card" style="flex:1; min-width:360px">
        <div class="row" style="align-items:end">
          <div>
            <label>項目名</label>
            <input id="newName" type="text" placeholder="例：睡眠、仕事、運動…" />
          </div>
          <div>
            <label>色</label>
            <input id="newColor" type="color" value="#3b82f6" />
          </div>
          <div>
            <label>THP属性</label>
            <select id="newThp">
              <option value="none">紐づけなし</option>
              <option value="sleep">睡眠</option>
              <option value="meal">食事</option>
              <option value="exercise">運動</option>
              <option value="leisure">余暇</option>
              <option value="consult">相談・交流</option>
              <option value="stress">ストレス発散</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="addItem" class="primary">＋ 項目を追加</button>
          </div>
          <div style="flex:1"></div>
          <div>
            <label>一括入力</label>
            <div class="row" style="gap:6px; align-items:center">
              <select id="bulkDay"></select>
              <input id="bulkStart" type="time" value="22:00">〜
              <input id="bulkEnd" type="time" value="06:00">
              <button id="bulkFill">塗る</button>
            </div>
            <div class="small">※ 30分刻み／夜またぎOK（22:00→06:00など）</div>
          </div>
        </div>
        <div class="small" style="margin-top:8px">パレット（タップで選択／もう一度で編集・削除）</div>
        <div id="palette" class="palette"></div>
      </div>

      <div class="card" style="min-width:260px">
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <button id="exportCsv">CSV出力</button>
          <button id="printPage">印刷 / PDF</button>
          <button id="toggleThp" aria-expanded="false">THPチェックを表示</button>
          <button id="clearAll" style="background:#ef4444;color:#fff;border-color:transparent">全消去</button>
        </div>
      </div>
    </div>

    <div id="cardSchedule" class="card" style="margin-top:12px">
      <div class="gridwrap"><table id="grid"></table></div>
      <div class="totals" id="totals"></div>
    </div>

    <!-- 下：THP結果（初期は閉じる） -->
    <div id="cardTHP" class="card" style="margin-top:12px; display:none">
      <div class="small" style="margin-bottom:6px"><b>THPチェック（自動判定）</b></div>
      <div id="thpPanel" class="thp"></div>
      <div class="small" style="margin-top:6px">基準：睡眠6h以上の日が5日以上／食事は1日3回相当が5日以上／運動は週150分以上または30分以上×3日／相談・交流1h以上/週／余暇3h以上/週／ストレス発散1h以上/週</div>
    </div>
  </div>

<script>
(()=>{
  const days=["月","火","水","木","金","土","日"]; const SLOTS=48; // 30分刻み
  const START_AT_SLOT=10; // 5:00開始（0:00基準で5:00=10）
  let schedule=Array.from({length:7},()=>Array(SLOTS).fill(null));
  let items=[]; let selectedKey=null;

  const el=id=>document.getElementById(id);
  const gridEl=el('grid'); const paletteEl=el('palette'); const totalsEl=el('totals'); const thpPanel=el('thpPanel');

  const presets=[
    {name:'睡眠', color:'#0ea5e9', thp:'sleep'},
    {name:'仕事', color:'#f97316', thp:'none'},
    {name:'食事', color:'#10b981', thp:'meal'},
    {name:'通学・通勤', color:'#a855f7', thp:'none'},
    {name:'余暇', color:'#eab308', thp:'leisure'},
    {name:'運動', color:'#ef4444', thp:'exercise'}
  ];

  const uid=()=> 'i_'+Math.random().toString(36).slice(2,9);

  // ===== グリッド（表示は5:00始まり） =====
  const displaySlotIndex = row => (START_AT_SLOT + row) % SLOTS;
  const slotToTime = s => { const h=Math.floor(s/2), m=s%2?30:0; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; };

  function buildGrid(){
    const thead=document.createElement('thead'); const tbody=document.createElement('tbody');
    const hr=document.createElement('tr'); const th0=document.createElement('th'); th0.className='timecol'; th0.textContent='時間'; hr.appendChild(th0); days.forEach(d=>{const th=document.createElement('th'); th.textContent=d; hr.appendChild(th)}); thead.appendChild(hr);
    for(let r=0;r<SLOTS;r++){
      const s=displaySlotIndex(r);
      const tr=document.createElement('tr'); const th=document.createElement('th'); th.className='timecol'; th.textContent=slotToTime(s); tr.appendChild(th);
      for(let d=0; d<7; d++){
        const td=document.createElement('td'); td.className='slot'; td.dataset.d=d; td.dataset.s=s;
        td.addEventListener('mousedown', startPaint); td.addEventListener('mouseover', movePaint); td.addEventListener('click', e=>{ if(!isDragging) toggleCell(td); });
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    gridEl.innerHTML=''; gridEl.appendChild(thead); gridEl.appendChild(tbody);
  }

  // ===== 描画 =====
  function renderCells(){
    gridEl.querySelectorAll('td.slot').forEach(td=>{
      const d=+td.dataset.d, s=+td.dataset.s; const key=schedule[d][s];
      if(!key){ td.removeAttribute('data-item'); td.style.background='#fff'; td.textContent=''; td.style.color=''; }
      else{ const it=items.find(i=>i.key===key); td.dataset.item=key; td.style.background=it?.color||'#ddd'; td.textContent=it?.name||''; td.style.color='#fff'; }
    });
  }

  function renderTotals(){
    const cnt={}; items.forEach(it=>cnt[it.key]=0); 
    for(let d=0; d<7; d++){ for(let s=0; s<SLOTS; s++){ const k=schedule[d][s]; if(k) cnt[k]++; } }
    totalsEl.innerHTML=''; items.forEach(it=>{ const div=document.createElement('div'); const hrs=(cnt[it.key]*0.5).toFixed(1); div.className='pill'; div.innerHTML=`<span class="dot" style="background:${it.color}"></span><b>${it.name}</b>: ${hrs} 時間`; totalsEl.appendChild(div); });
  }

  function renderPalette(){
    paletteEl.innerHTML=''; items.forEach(it=>{ const tag=document.createElement('div'); tag.className='tag'+(it.key===selectedKey?' active':''); tag.title = it.thp && it.thp!=='none' ? `THP: ${it.thp}` : '';
      tag.innerHTML=`<span class="dot" style="background:${it.color}"></span>${it.name}`; tag.addEventListener('click',()=>{ if(selectedKey===it.key){ editItem(it); } else { selectedKey=it.key; renderPalette(); }}); paletteEl.appendChild(tag); });
  }

  function editItem(it){
    const name=prompt('名称を編集（空で削除）', it.name); if(name===null) return; if(name===''){ if(confirm('削除しますか？')){ items=items.filter(x=>x.key!==it.key); for(let d=0; d<7; d++) for(let s=0; s<SLOTS; s++) if(schedule[d][s]===it.key) schedule[d][s]=null; selectedKey=null; updateAll(); } return; }
    const color=prompt('色（#rrggbb）', it.color)||it.color; const thp=prompt('THP属性（none/sleep/meal/exercise/leisure/consult/stress）', it.thp||'none')||it.thp||'none'; it.name=name; it.color=color; it.thp=thp; updateAll();
  }

  function updateAll(){ renderCells(); renderPalette(); renderTotals(); updateBulkDayOptions(); renderTHP(); }

  // ===== ペイント =====
  let isDragging=false, dragKey=null;
  function toggleCell(td){ if(!selectedKey){ alert('先にパレットで項目を選んでください'); return; } const d=+td.dataset.d, s=+td.dataset.s; schedule[d][s]= (schedule[d][s]===selectedKey)? null : selectedKey; updateAll(); }
  function startPaint(e){ if(!selectedKey) return; isDragging=true; dragKey=selectedKey; toggleCell(e.currentTarget); }
  function movePaint(e){ if(isDragging && dragKey){ const td=e.currentTarget; const d=+td.dataset.d, s=+td.dataset.s; schedule[d][s]=dragKey; const it = items.find(i=>i.key===dragKey); td.style.background=it?.color||'#ddd'; td.textContent=it?.name||''; td.style.color='#fff'; }}
  document.addEventListener('mouseup',()=>{ isDragging=false; dragKey=null; renderTotals(); renderTHP(); });

  // ===== 一括入力 =====
  function timeToSlot(t){ const [hh,mm]=t.split(':').map(Number); return hh*2 + (mm>=30?1:0); }
  function rangeSlots(a,b){ const r=[]; if(a===b) return r; if(b>a){ for(let i=a;i<b;i++) r.push(i);} else { for(let i=a;i<48;i++) r.push(i); for(let i=0;i<b;i++) r.push(i);} return r; }
  function bulkFill(){ if(!selectedKey){ alert('先にパレットで項目を選んでください'); return; } const d=+el('bulkDay').value; const s=timeToSlot(el('bulkStart').value); const e=timeToSlot(el('bulkEnd').value); rangeSlots(s,e).forEach(i=> schedule[d][i]=selectedKey); updateAll(); }

  // ===== 出力/印刷/クリア =====
  function exportCsv(){ const lines=['day,time,item']; for(let d=0; d<7; d++){ for(let row=0; row<48; row++){ const s=displaySlotIndex(row); const key=schedule[d][s]; const name= key? (items.find(i=>i.key===key)?.name||'') : ''; lines.push(`${days[d]},${slotToTime(s)},${name}`); }} const blob=new Blob([lines.join('¥n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='schedule.csv'; a.click(); URL.revokeObjectURL(a.href); }
  function clearAll(){ if(confirm('すべて消去します。よろしいですか？')){ schedule=Array.from({length:7},()=>Array(48).fill(null)); updateAll(); }}

  // ===== THP 自動判定 =====
  function renderTHP(){
    const catByDay = {sleep:Array(7).fill(0), meal:Array(7).fill(0), exercise:Array(7).fill(0), leisure:Array(7).fill(0), consult:Array(7).fill(0), stress:Array(7).fill(0)};
    for(let d=0; d<7; d++){
      for(let s=0; s<48; s++){
        const k=schedule[d][s]; if(!k) continue; const thp=(items.find(i=>i.key===k)?.thp)||'none'; if(catByDay[thp]!=null) catByDay[thp][d]++;
      }
    }
    const sumSlots=a=>a.reduce((x,y)=>x+y,0);
    const sleepDaysOK = catByDay.sleep.filter(x=>x>=12).length; // 6h
    const mealDaysOK  = catByDay.meal.filter(x=>x>=3).length;   // 3回相当
    const exWeekMin   = sumSlots(catByDay.exercise)*30;
    const exDays30m   = catByDay.exercise.filter(x=>x>=1).length;
    const consultMin  = sumSlots(catByDay.consult)*30;
    const leisureMin  = sumSlots(catByDay.leisure)*30;
    const stressMin   = sumSlots(catByDay.stress)*30;

    const blocks=[]; const add=(ok,title,detail)=> blocks.push(`<div class="c ${ok?'ok':'warn'}"><h4>${title} ${ok?'✅':'⚠️'}</h4><p>${detail}</p></div>`);
    add(sleepDaysOK>=5,'睡眠',`6時間以上の日：${sleepDaysOK}/7日`);
    add(mealDaysOK>=5,'食事',`1日3回相当の日：${mealDaysOK}/7日`);
    add(exWeekMin>=150 || exDays30m>=3,'運動',`週合計：${exWeekMin}分／30分以上の日：${exDays30m}日`);
    add(consultMin>=60,'相談・交流',`週合計：${consultMin}分`);
    add(leisureMin>=180,'余暇',`週合計：${leisureMin}分`);
    add(stressMin>=60,'ストレス発散',`週合計：${stressMin}分`);
    thpPanel.innerHTML = blocks.join('');
  }

  // ===== 初期化 =====
  function updateBulkDayOptions(){ const sel=el('bulkDay'); if(sel.options.length) return; days.forEach((d,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=d; sel.appendChild(o); }); }
  function init(){ buildGrid(); presets.forEach(p=> items.push({...p, key:uid()})); selectedKey = items[0].key; updateAll(); }

  // イベント
  el('addItem').addEventListener('click',()=>{ const name=el('newName').value.trim(); if(!name){ alert('項目名を入力'); return; } const color=el('newColor').value||'#3b82f6'; const thp=el('newThp').value||'none'; const it={key:uid(), name, color, thp}; items.push(it); selectedKey=it.key; el('newName').value=''; updateAll(); });
  el('bulkFill').addEventListener('click', bulkFill);
  el('exportCsv').addEventListener('click', exportCsv);
  el('printPage').addEventListener('click', ()=>window.print());
  el('clearAll').addEventListener('click', clearAll);

  // タイトル同期
  const titleInput = el('titleInput'); const titleDisplay = el('titleDisplay');
  if(titleInput && titleDisplay){ const syncTitle=()=>{ titleDisplay.textContent = titleInput.value.trim() || '（タイトル）'; }; titleInput.addEventListener('input', syncTitle); syncTitle(); }

  // THPトグル
  const thpCard = el('cardTHP'); const thpBtn = el('toggleThp');
  if(thpCard && thpBtn){
    thpBtn.addEventListener('click', ()=>{
      const open = thpCard.style.display === 'none' || thpCard.style.display === '';
      if(open){ renderTHP(); thpCard.style.display='block'; thpBtn.textContent='THPチェックを閉じる'; thpBtn.setAttribute('aria-expanded','true'); }
      else { thpCard.style.display='none'; thpBtn.textContent='THPチェックを表示'; thpBtn.setAttribute('aria-expanded','false'); }
    });
  }

  init();
})();
</script>
</body>
</html>
